module example_metrics is
; <- keyword
;      ^ module.definition
;                      ^ keyword

  entity Ad is
  ; <- keyword
  ;      ^ type.definition
  ;         ^ keyword
    identity adId -> long
    ; <- keyword
    ;        ^ variable.field
    ;              operator
    ;                ^ type
  end
  ; <- keyword

  event Impression is
  ; <- keyword
  ;     ^ type.definition
  ;                ^ keyword
    source Ad
    ; <- keyword
    ;      ^ type
  end
  ; <- keyword

  metric group Impressions on Impression is
  ; <- keyword
  ;      ^ keyword
  ;            ^ type.definition
  ;                        ^ keyword
  ;                           ^ type
  ;                                      ^ keyword
    metric grossImpressions -> count := count(event)
    ; <- keyword
    ;      ^ function.definition
    ;                       ^ operator
    ;                          ^ type
    ;                                ^ operator
    ;                                   ^ function.call
    ;                                        ^ punctuation.bracket
    ;                                         ^ variable.builtin
    ;                                              ^ punctuation.bracket
    metric invalidImpressions -> count
    metric impressions -> count := grossImpressions - invalidImpressions
  end
  ; <- keyword

  event Click is
  ; <- keyword
  ;     ^ type.definition
  ;           ^ keyword
    source Ad
    ; <- keyword
    ;      ^ type
  end
  ; <- keyword

  metric group Impressions on Impression is
  ; <- keyword
  ;      ^ keyword
  ;            ^ type.definition
  ;                        ^ keyword
  ;                           ^ type
  ;                                      ^ keyword
    metric grossClicks -> count := count(event)
    metric invalidClicks -> count
    metric clicks -> count := grossClicks - invalidClicks
    metric ctr(impressions -> Impressions) -> percentageRate := clicks / impressions.impressions
  end
  ; <- keyword

end
; <- keyword
